<!DOCTYPE html>
<html>
<head>
    <title>è§’è‰²ç®¡ç†å™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>æ¸¸æˆè§’è‰²ç®¡ç†</h1>
    <nav class="main-nav">
        <a href="/douququ" class="nav-item">
            ğŸ† è¿›å…¥æ–—è›è›æ¨¡å¼
        </a>
        <a href="#" id="startPokemonBattle" class="nav-item">
            âš”ï¸ å®å¯æ¢¦å¼å¯¹æˆ˜ (é€‰æ‹©è§’è‰²)
        </a>
    </nav>

    <div id="selection-prompt" class="selection-prompt" style="display: none;">
        è¯·é€‰æ‹©ç©å®¶1çš„è§’è‰²...
    </div>

    <form action="/create" method="POST">
        <button type="submit" class="btn-create">åˆ›å»ºæ–°è§’è‰²</button>
    </form>
    
    <div class="character-list">
        {% for char in characters %}
        <div class="character-card">
            <div class="character-image-wrapper">
                {% if char.image %}
                <img src="{{ url_for('uploaded_file', filename=char.image) }}" alt="{{ char.name }}" class="character-image">
                {% endif %}
            </div>
            <div class="character-info">
                <h2>{{ char.name }}</h2>
                <div class="character-meta">
                  <span class="hp-badge">{{ char.stats.hp }} HP</span>
                  <span class="element-tag element-{{ char.element }}">{{ char.element }}</span>
                </div>
                {% set char_win_rates = win_rates.get(char.id | string, {"total_battles": 0, "wins": 0}) %}
                {% set total_battles = char_win_rates.total_battles %}
                {% set wins = char_win_rates.wins %}
                {% set win_percentage = (wins / total_battles * 100) if total_battles > 0 else 0 %}
                <div class="win-rate">
                    èƒœç‡: {{ "%.2f" | format(win_percentage) }}% ({{ wins }}èƒœ / {{ total_battles }}æ€»)
                </div>
                
                {% if char.skills %}
                <div class="skills">
                    <h3>æŠ€èƒ½:</h3>
                    <ul class="skill-list">
                        {% for skill in char.skills %}
                        <li class="skill-item">
                            <strong>{{ skill.name }}:</strong>
                            <div class="skill-desc">{{ skill.effect }}</div>
                            {% if skill.damage %}
                            (ä¼¤å®³:
                            {% for element, value in skill.damage.items() %}
                            {% if value > 0 %}
                            {{ value }}{{ element }}
                            {% endif %}
                            {% endfor %})
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if char.attributes %}
                <div class="attributes">
                    <h3>ç‰¹æ€§:</h3>
                    <ul class="attribute-list">
                        {% for attr in char.attributes %}
                        <li class="attribute-item">
                            <strong>{{ attr.name }}:</strong>
                            {% if attr.resistance %}
                            (æŠ—æ€§:
                            {% for element, value in attr.resistance.items() %}
                            {% if value > 0 %}
                            {{ value }}%{{ element }}
                            {% endif %}
                            {% endfor %})
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            <div class="actions">
                <button onclick="location.href='/edit/{{ char.id }}'" class="btn-edit">ç¼–è¾‘</button>
                <form action="/delete/{{ char.id }}" method="POST" style="display:inline;">
                    <button type="submit" class="delete-btn">åˆ é™¤</button>
                </form>
                <button class="select-for-pokemon-battle-btn btn-battle" data-char-id="{{ char.id }}" data-char-name="{{ char.name }}">é€‰æ‹©å¯¹æˆ˜</button>
            </div>
        </div>
        {% endfor %}
    </div>
    <footer class="main-footer">
      Â© 2025 å¡ç‰Œæ¸¸æˆè§’è‰²ç®¡ç†å™¨
    </footer>

    <script>
        // æ¶Ÿæ¼ªæ•ˆæœJS
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                const rect = btn.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                ripple.style.width = ripple.style.height = `${size}px`;
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                btn.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });

        // é¡µé¢è¿‡æ¸¡JS
        function navigate(path) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = path;
            }, 300);
        }

        let player1SelectedCharId = null;
        let player1SelectedCharName = null;
        const selectionPrompt = document.getElementById('selection-prompt');
        const pokemonBattleLink = document.getElementById('startPokemonBattle');
        const selectButtons = document.querySelectorAll('.select-for-pokemon-battle-btn');

        pokemonBattleLink.addEventListener('click', (event) => {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤è·³è½¬
            player1SelectedCharId = null; // é‡ç½®é€‰æ‹©
            player1SelectedCharName = null;
            selectionPrompt.textContent = 'è¯·é€‰æ‹©ç©å®¶1çš„è§’è‰²...';
            selectionPrompt.style.display = 'block';
            
            // å¯ç”¨æ‰€æœ‰é€‰æ‹©æŒ‰é’®
            selectButtons.forEach(button => {
                button.disabled = false;
                button.textContent = 'é€‰æ‹©å¯¹æˆ˜';
                button.classList.remove('selected-player1'); // ç§»é™¤é€‰ä¸­çŠ¶æ€
            });
        });

        selectButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const charId = event.target.dataset.charId;
                const charName = event.target.dataset.charName;

                if (player1SelectedCharId === null) {
                    // ç¬¬ä¸€æ¬¡é€‰æ‹©ï¼šé€‰æ‹©ç©å®¶1
                    player1SelectedCharId = charId;
                    player1SelectedCharName = charName;
                    selectionPrompt.textContent = `ç©å®¶1å·²é€‰æ‹©: ${charName}ã€‚è¯·é€‰æ‹©ç©å®¶2çš„è§’è‰²...`;
                    event.target.disabled = true; // ç¦ç”¨å·²é€‰æ‹©çš„æŒ‰é’®
                    event.target.textContent = 'å·²é€‰æ‹© (ç©å®¶1)';
                    event.target.classList.add('selected-player1'); // æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»

                    // ç¦ç”¨å…¶ä»–å·²é€‰æ‹©çš„æŒ‰é’®
                    selectButtons.forEach(btn => {
                        if (btn.dataset.charId === player1SelectedCharId) {
                            btn.disabled = true;
                        } else {
                            btn.disabled = false; // ç¡®ä¿å…¶ä»–æŒ‰é’®å¯ç”¨
                            btn.textContent = 'é€‰æ‹©å¯¹æˆ˜';
                            btn.classList.remove('selected-player1');
                        }
                    });

                } else if (player1SelectedCharId === charId) {
                    // å†æ¬¡ç‚¹å‡»åŒä¸€ä¸ªè§’è‰²ï¼Œå–æ¶ˆé€‰æ‹©
                    player1SelectedCharId = null;
                    player1SelectedCharName = null;
                    selectionPrompt.textContent = 'è¯·é€‰æ‹©ç©å®¶1çš„è§’è‰²...';
                    event.target.disabled = false;
                    event.target.textContent = 'é€‰æ‹©å¯¹æˆ˜';
                    event.target.classList.remove('selected-player1');
                }
                else {
                    // ç¬¬äºŒæ¬¡é€‰æ‹©ï¼šé€‰æ‹©ç©å®¶2ï¼Œå¹¶å¼€å§‹å¯¹æˆ˜
                    const player2SelectedCharId = charId;
                    selectionPrompt.style.display = 'none'; // éšè—æç¤º
                    
                    // è·³è½¬åˆ°å¯¹æˆ˜é¡µé¢
                    navigate(`/pokemon_battle?player1_id=${player1SelectedCharId}&player2_id=${player2SelectedCharId}`);
                }
            });
        });
    </script>
</body>
</html>