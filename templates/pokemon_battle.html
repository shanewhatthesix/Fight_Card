<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®å¯æ¢¦å¼å¯¹æˆ˜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="main-nav">
        <a href="/" class="nav-item">
            ğŸ  è¿”å›ä¸»é¡µ
        </a>
    </nav>
    <div class="container battle-page-container">
        <h1>å®å¯æ¢¦å¼å¯¹æˆ˜</h1>
        <div class="battle-container">
            <div class="turn-counter" id="turn-counter">å›åˆæ•°: 1</div>
            <div class="top-row">
                <div class="player-section player1">
                    <div class="player-card-display" id="player1-card-display">
                        <!-- ç©å®¶1å¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
                        <h3>ç©å®¶1</h3>
                    </div>
                    <div class="skill-list-display" id="player1-skills-display">
                        <h3>æŠ€èƒ½åˆ—è¡¨</h3>
                        <!-- ç©å®¶1æŠ€èƒ½åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                <div class="vs-display">
                    <span class="vs-text">VS</span>
                    <div id="battle-action-display" class="battle-action-display">
                        <!-- æ‹›å¼åç§°å’Œæ•ˆæœå°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                <div class="player-section player2">
                    <div class="skill-list-display" id="player2-skills-display">
                        <h3>æŠ€èƒ½åˆ—è¡¨</h3>
                        <!-- ç©å®¶2æŠ€èƒ½åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                    <div class="player-card-display" id="player2-card-display">
                        <!-- ç©å®¶2å¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
                        <h3>ç©å®¶2</h3>
                    </div>
                </div>
            </div>

            <div class="battle-log-section hidden" id="battle-log">
                <h3>æˆ˜æ–—æ—¥å¿—</h3>
                <!-- æˆ˜æ–—æ—¥å¿—å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <footer class="main-footer">
      Â© 2025 å¡ç‰Œæ¸¸æˆè§’è‰²ç®¡ç†å™¨
    </footer>

    <script>
        let battleState = {}; // ç”¨äºå­˜å‚¨å½“å‰æˆ˜æ–—çŠ¶æ€
        let player1Id = null;
        let player2Id = null;
        let battleActionDisplay = null; // å°† battleActionDisplay å£°æ˜ä¸ºå…¨å±€å˜é‡
// ç§»é™¤å…¨å±€éŸ³é¢‘å˜é‡

        document.addEventListener('DOMContentLoaded', () => {
            // ä»URLå‚æ•°è·å–è§’è‰²ID
            const urlParams = new URLSearchParams(window.location.search);
            player1Id = urlParams.get('player1_id');
            player2Id = urlParams.get('player2_id');

            if (player1Id && player2Id) {
                initializeBattle(player1Id, player2Id);
            } else {
                document.getElementById('battle-log').innerHTML = '<p class="log-entry event-end">é”™è¯¯ï¼šç¼ºå°‘ç©å®¶è§’è‰²IDã€‚</p>';
            }
        });

        async function initializeBattle(p1Id, p2Id) {
            try {
                const response = await fetch('/api/pokemon_battle/init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ player1_id: p1Id, player2_id: p2Id })
                });
                const data = await response.json();
                if (data.success) {
                    battleState = data.state;
                    updateUI();
                } else {
                    alert('åˆå§‹åŒ–æˆ˜æ–—å¤±è´¥: ' + data.message);
                    document.getElementById('battle-log').innerHTML = `<p class="log-entry event-end">åˆå§‹åŒ–æˆ˜æ–—å¤±è´¥: ${data.message}</p>`;
                }
            } catch (error) {
                console.error('Error initializing battle:', error);
                alert('åˆå§‹åŒ–æˆ˜æ–—æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚');
                document.getElementById('battle-log').innerHTML = `<p class="log-entry event-end">åˆå§‹åŒ–æˆ˜æ–—æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚</p>`;
            }
        }

        function updateUI() {
            const player1CardDisplay = document.getElementById('player1-card-display');
            const player2CardDisplay = document.getElementById('player2-card-display');
            const player1SkillsDisplay = document.getElementById('player1-skills-display');
            const player2SkillsDisplay = document.getElementById('player2-skills-display');
            const battleLog = document.getElementById('battle-log');
            const turnCounter = document.getElementById('turn-counter');
            battleActionDisplay = document.getElementById('battle-action-display'); // åœ¨è¿™é‡Œèµ‹å€¼

            // Clear previous content
            player1CardDisplay.innerHTML = '<h3>ç©å®¶1</h3>';
            player2CardDisplay.innerHTML = '<h3>ç©å®¶2</h3>';
            player1SkillsDisplay.innerHTML = '<h3>æŠ€èƒ½åˆ—è¡¨</h3>';
            player2SkillsDisplay.innerHTML = '<h3>æŠ€èƒ½åˆ—è¡¨</h3>';
            battleLog.innerHTML = '<h3>æˆ˜æ–—æ—¥å¿—</h3>';

            if (!battleState || !battleState.characters) {
                battleLog.innerHTML += '<p class="log-entry">ç­‰å¾…æˆ˜æ–—åˆå§‹åŒ–...</p>';
                return;
            }

            // Update turn counter
            turnCounter.textContent = `å›åˆæ•°: ${battleState.current_turn}`;

            // Update character cards and skill lists
            battleState.characters.forEach(char => {
                const currentHp = Math.max(0, char.current_hp);
                const maxHp = char.stats.hp;
                const hpPercentage = (currentHp / maxHp) * 100;

                const charCardContent = `
                    <div class="character-image-wrapper battle-character-image-wrapper">
                        <img src="/static/assets/${char.image}" alt="${char.name}" class="character-image battle-character-image">
                    </div>
                    <div class="character-info battle-character-info">
                        <h3>${char.name}</h3>
                        <p>ç”Ÿå‘½å€¼: ${currentHp.toFixed(0)} / ${maxHp.toFixed(0)}</p>
                        <div class="hp-bar-container">
                            <div class="hp-bar">
                                <div class="hp-fill" style="width: ${hpPercentage}%; background-color: ${hpPercentage > 50 ? 'var(--success)' : (hpPercentage > 20 ? 'var(--warning)' : 'var(--danger)')};"></div>
                            </div>
                        </div>
                    </div>
                `;

                const skillsSectionContent = `
                    ${char.current_hp > 0 && battleState.active_character_id === char.id && !battleState.battle_ended ?
                        char.skills.map(skill => `<button class="btn-skill" onclick="selectSkill(${char.id}, '${skill.name}')" data-skill-name="${skill.name}">${skill.name}</button>`).join('') :
                        (char.current_hp <= 0 ? '<p>å·²é˜µäº¡</p>' : '<p>ç­‰å¾…è¡ŒåŠ¨...</p>')
                    }
                `;

                if (battleState.team1_ids.includes(char.id)) {
                    player1CardDisplay.innerHTML = charCardContent;
                    player1SkillsDisplay.innerHTML = `<h3>æŠ€èƒ½åˆ—è¡¨</h3>${skillsSectionContent}`;
                } else if (battleState.team2_ids.includes(char.id)) {
                    player2CardDisplay.innerHTML = charCardContent;
                    player2SkillsDisplay.innerHTML = `<h3>æŠ€èƒ½åˆ—è¡¨</h3>${skillsSectionContent}`;
                }
            });

            // Control battle log visibility
            if (battleState.battle_ended) {
                battleLog.classList.remove('hidden');
                if (battleState.battle_log && battleState.battle_log.length > 0) {
                    battleState.battle_log.forEach(entry => {
                        const logEntry = document.createElement('p');
                        logEntry.className = `log-entry event-${entry.event}`;
                        logEntry.textContent = entry.message;
                        battleLog.appendChild(logEntry);
                    });
                    battleLog.scrollTop = battleLog.scrollHeight; // Scroll to bottom
                }
            } else {
                battleLog.classList.add('hidden');
            }

            // Disable all skill buttons if battle ended
            if (battleState.battle_ended) {
                document.querySelectorAll('.skill-list-display button').forEach(button => {
                    button.disabled = true;
                });
            } else {
                // Enable current active character's skill buttons
                document.querySelectorAll('.skill-list-display button').forEach(button => {
                    button.disabled = true; // Default disable all
                });
                const activeChar = battleState.characters.find(c => c.id === battleState.active_character_id);
                if (activeChar) {
                    const activeCharSkillsDisplay = battleState.team1_ids.includes(activeChar.id) ? player1SkillsDisplay : player2SkillsDisplay;
                    activeCharSkillsDisplay.querySelectorAll('button').forEach(button => {
                        button.disabled = false;
                    });
                }
            }
        }

        async function selectSkill(characterId, skillName) {
            if (battleState.battle_ended) {
                alert('æˆ˜æ–—å·²ç»“æŸï¼Œæ— æ³•é€‰æ‹©æŠ€èƒ½ã€‚');
                return;
            }
            if (battleState.active_character_id !== characterId) {
                alert('ç°åœ¨ä¸æ˜¯è¯¥è§’è‰²çš„å›åˆã€‚');
                return;
            }

            // ç¦ç”¨æ‰€æœ‰æŠ€èƒ½æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            document.querySelectorAll('.skill-list-display button').forEach(button => {
                button.disabled = true;
            });

            try {
                console.log('Sending skill action request:', { battle_id: battleState.battle_id, character_id: characterId, skill_name: skillName });
                const response = await fetch('/api/pokemon_battle/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ battle_id: battleState.battle_id, character_id: characterId, skill_name: skillName })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server responded with an error:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                const data = await response.json();
                console.log('Received skill action response:', data);

                if (data.success) {
                    battleState = data.state;
                    
                    // æ˜¾ç¤ºæŠ€èƒ½åç§°ã€æ•ˆæœå’Œä¼¤å®³åŠ¨ç”»
                    battleActionDisplay.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„æ˜¾ç¤º

                    if (data.skill_used) {
                        const skillNameText = document.createElement('div');
                        skillNameText.classList.add('skill-name-text');
                        skillNameText.textContent = data.skill_used;
                        skillNameText.style.color = data.skill_element_color || 'var(--primary)'; // æ ¹æ®å…ƒç´ è®¾ç½®é¢œè‰²
                        battleActionDisplay.appendChild(skillNameText);

                        if (data.effect) {
                            const skillEffectText = document.createElement('div');
                            skillEffectText.classList.add('skill-effect-text');
                            skillEffectText.textContent = data.effect;
                            battleActionDisplay.appendChild(skillEffectText);
                        }
                        
                        // æ’­æ”¾éŸ³æ•ˆï¼ˆä¿®å¤å¤šæŠ€èƒ½å†²çªï¼‰
                        if (data.audio) {
                            const audio = new Audio(`/static/audio/${data.audio}`);
                            console.log('å°è¯•æ’­æ”¾éŸ³æ•ˆ:', data.audio);
                            console.log('å®Œæ•´éŸ³æ•ˆURL:', audio.src);
                            audio.play().catch(e => console.error("Error playing audio:", e));
                        }

                        // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                        setTimeout(() => {
                            battleActionDisplay.innerHTML = '';
                        }, 1500); // åŠ¨ç”»æŒç»­æ—¶é—´
                    }

                    if (data.damage_dealt !== undefined) {
                        const damageNumberText = document.createElement('div');
                        damageNumberText.classList.add('damage-number-text');
                        damageNumberText.textContent = `-${data.damage_dealt.toFixed(0)}`;
                        battleActionDisplay.appendChild(damageNumberText);

                        // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                        setTimeout(() => {
                            battleActionDisplay.innerHTML = '';
                        }, 1500); // åŠ¨ç”»æŒç»­æ—¶é—´
                    }

                    // æ”»å‡»åŠ¨ç”»
                    if (data.attacker_id && data.target_id) {
                        const attackerCard = document.querySelector(`#player${battleState.team1_ids.includes(data.attacker_id) ? '1' : '2'}-card-display`);
                        const targetCard = document.querySelector(`#player${battleState.team1_ids.includes(data.target_id) ? '1' : '2'}-card-display`);
                        
                        if (attackerCard) {
                            attackerCard.classList.add('attack-animation');
                            setTimeout(() => {
                                attackerCard.classList.remove('attack-animation');
                            }, 500); // æ”»å‡»åŠ¨ç”»æŒç»­æ—¶é—´
                        }
                        if (targetCard) {
                            targetCard.classList.add('damage-taken-animation');
                            setTimeout(() => {
                                targetCard.classList.remove('damage-taken-animation');
                            }, 500); // å—ä¼¤åŠ¨ç”»æŒç»­æ—¶é—´
                        }
                    }

                    // ç­‰å¾…åŠ¨ç”»ç»“æŸåæ›´æ–°UI
                    setTimeout(() => {
                        updateUI();
                        if (battleState.battle_ended) {
                            // å¦‚æœæˆ˜æ–—ç»“æŸï¼Œè·³è½¬åˆ°ç»“ç®—é¡µé¢
                            setTimeout(() => {
                                navigate(`/battle_result?player1_id=${player1Id}&player2_id=${player2Id}`);
                            }, 1000); // ç•™å‡ºæ—¶é—´æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
                        }
                    }, 1000); // ç¡®ä¿åŠ¨ç”»æœ‰è¶³å¤Ÿæ—¶é—´æ’­æ”¾
                    
                } else {
                    alert('æŠ€èƒ½ä½¿ç”¨å¤±è´¥: ' + data.message);
                    // é‡æ–°å¯ç”¨æŠ€èƒ½æŒ‰é’®
                    updateUI();
                }
            } catch (error) {
                console.error('Error using skill:', error);
                alert('ä½¿ç”¨æŠ€èƒ½æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚');
                // é‡æ–°å¯ç”¨æŠ€èƒ½æŒ‰é’®
                updateUI();
            }
        }

        // é¡µé¢è¿‡æ¸¡JS (ä»index.htmlå¤åˆ¶è¿‡æ¥ï¼Œç¡®ä¿æ‰€æœ‰é¡µé¢éƒ½æœ‰)
        function navigate(path) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = path;
            }, 300);
        }

        // æ¶Ÿæ¼ªæ•ˆæœJS (ä»index.htmlå¤åˆ¶è¿‡æ¥ï¼Œç¡®ä¿æ‰€æœ‰é¡µé¢éƒ½æœ‰)
        document.querySelectorAll('button, .btn-primary, .btn-secondary, .btn-skill').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                const rect = btn.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                ripple.style.width = ripple.style.height = `${size}px`;
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                btn.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });
    </script>
</body>
</html>